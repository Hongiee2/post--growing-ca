<!DOCTYPE html>
<meta charset="utf-8">

<title>Growing CA Demo 2</title>

<h1>Growing CA Demo 2</h1>

<p>Select target:
  <span id="emojiSelector"></span>
</p>

<canvas id="c" width="512" , height="512" style="image-rendering: pixelated; "></canvas><br>
Show: <select id='visMode'></select>
<button id="resetButton">Reset</button>
<button id="benchmarkButton">Benchmark</button>
<br>
<pre id='log'>
</pre>

<script src="twgl.min.js"></script>
<script type="module">
  import { createDemo } from './demo.js'

  const canvas = document.getElementById("c");
  const gl = canvas.getContext("webgl");

  let demo;

  fetch('webgl_models8/🦎.json').then(r => r.json()).then(layers => {
    demo = createDemo(gl, layers);
    const sel = document.getElementById('visMode');
    for (const mode of demo.visModes) {
      sel.innerHTML += `<option value="${mode}">${mode}</option>`;
    }

    document.getElementById('resetButton').onclick = demo.reset;

    requestAnimationFrame(render);
  });

  const modelSel = document.getElementById('emojiSelector');
  for (let c of '😀💥👁🦎🐠🦋🐞🕸🥨🎄') {
    modelSel.innerHTML += `<span>${c}</span>`;
  }
  modelSel.onclick = async e => {
    if (!demo)
      return;
    const emoji = e.target.innerText;
    const url = `webgl_models8/${emoji}.json`;
    const r = await fetch(url);
    const model = await r.json();
    demo.setWeights(model);
    demo.reset();
  }

  function getMousePos(e) {
    const x = Math.floor(e.offsetX / canvas.width * 128);
    const y = Math.floor(e.offsetY / canvas.height * 128);
    return [x, y];
  }

  let doubleClick = false;

  canvas.onmousedown = e => {
    e.preventDefault();
    if (!demo)
      return;
    const [x, y] = getMousePos(e);
    if (e.buttons == 1) {
      if (doubleClick) {
        demo.paint(x, y, 1, 'seed');
        doubleClick = false;
      } else {
        doubleClick = true;
        setTimeout(()=>{
          doubleClick = false;
        }, 300);
        demo.paint(x, y, 8, 'clear');
      }
    }
  }
  canvas.onmousemove = e => {
    e.preventDefault();
    if (!demo)
      return;
    const [x, y] = getMousePos(e);
    if (e.buttons == 1 && !e.shiftKey) {
      demo.paint(x, y, 8, 'clear');
    }
  }

  function render(time) {
    if (!demo)
      return;
    demo.step();
    twgl.bindFramebufferInfo(gl);
    const mode = document.getElementById("visMode").value;
    demo.draw(mode);
    requestAnimationFrame(render);
  }


  function benchmark() {
    if (!demo)
      return;
    document.getElementById('log').innerHTML += demo.benchmark();
  }

  document.getElementById('benchmarkButton').onclick = benchmark;

</script>